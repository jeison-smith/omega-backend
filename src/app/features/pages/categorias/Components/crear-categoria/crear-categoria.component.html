<!-- Contenedor Principal Centrado -->
<div class="mx-auto max-w-[1800px] px-10 py-5">
  <!-- Botón Crear Categoría -->
  <div class="mb-6">
    <button
      class="inline-flex items-center gap-2 rounded-xl bg-sky-500 px-4 py-2 text-sm font-semibold text-white transition hover:bg-sky-600"
      (click)="showDialog()"
    >
      <span class="material-symbols">add</span>
      Crear Categoría
    </button>
  </div>

  <!-- Buscador -->
  <div class="mb-6 flex justify-end rounded-lg bg-white p-4 shadow-sm">
    <div class="flex items-center">
      <input
        type="text"
        placeholder="Filtra aquí"
        [(ngModel)]="filtro"
        (input)="buscar()"
        class="h-10 min-w-[250px] rounded-l-lg border border-slate-300 border-r-0 px-4 text-sm text-slate-700 outline-none"
      >
      <button
        class="inline-flex h-10 items-center gap-2 rounded-r-lg border border-purple-200 bg-purple-100 px-4 text-sm font-semibold text-slate-900 transition hover:bg-purple-200"
      >
        <span class="material-symbols">search</span>
        Buscar
      </button>
    </div>
  </div>

  <!-- Tabla de Categorías -->
  <div class="overflow-hidden rounded-lg bg-white shadow-sm">
    <table class="w-full border-collapse">
      <thead>
        <tr>
          <th class="bg-slate-50 px-4 py-3 text-center text-sm font-semibold text-slate-700">Id</th>
          <th class="bg-slate-50 px-4 py-3 text-center text-sm font-semibold text-slate-700">Nombre</th>
          <th class="bg-slate-50 px-4 py-3 text-center text-sm font-semibold text-slate-700">Proyecto</th>
          <th class="bg-slate-50 px-4 py-3 text-center text-sm font-semibold text-slate-700">Creador</th>
          <th class="bg-slate-50 px-4 py-3 text-center text-sm font-semibold text-slate-700">
            Fecha de creación
          </th>
          <th class="bg-slate-50 px-4 py-3 text-center text-sm font-semibold text-slate-700">
            Últ. actualización
          </th>
          <th class="bg-slate-50 px-4 py-3 text-center text-sm font-semibold text-slate-700">Estado</th>
          <th class="bg-slate-50 px-4 py-3 text-center text-sm font-semibold text-slate-700">Acción</th>
        </tr>
      </thead>

      <tbody>
        <tr *ngFor="let cat of categoriasPaginadas" class="transition hover:bg-slate-50">
          <!-- ID -->
          <td class="px-4 py-3 text-center text-sm text-slate-700">{{ cat.id }}</td>

          <!-- Nombre -->
          <td class="px-4 py-3 text-center text-sm text-slate-700">{{ cat.nombre }}</td>

          <!-- Proyecto -->
          <td class="px-4 py-3 text-center text-sm text-slate-700">{{ cat.proyectoNombre }}</td>

          <!-- Creador -->
          <td class="px-4 py-3 text-center text-sm text-slate-700">
            {{ obtenerNombreUsuario(cat.usuarioCreador) }}
          </td>

          <!-- Fecha de Creación -->
          <td class="px-4 py-3 text-center text-sm text-slate-700">
            {{ cat.fechaCreacion | date:"dd/MM/yyyy" }}
          </td>

          <!-- Última Actualización -->
          <td class="px-4 py-3 text-center text-sm text-slate-700">
            {{ cat.fechaModificacion ? (cat.fechaModificacion | date:"dd/MM/yyyy") : '—' }}
          </td>

          <!-- Estado con Toggle -->
          <td class="px-4 py-3 text-center text-sm text-slate-700">
            <div class="flex items-center justify-center gap-2">
              <span
                [class]="
                  cat.estado
                    ? 'inline-flex items-center rounded-full bg-emerald-100 px-2.5 py-1 text-xs font-semibold text-emerald-700'
                    : 'inline-flex items-center rounded-full bg-rose-100 px-2.5 py-1 text-xs font-semibold text-rose-700'
                "
              >
                {{ cat.estado ? 'Activo' : 'Inactivo' }}
              </span>

              <!-- Toggle Switch -->
              <label class="relative inline-flex h-6 w-12 shrink-0 cursor-pointer items-center">
                <input
                  type="checkbox"
                  class="peer sr-only"
                  [checked]="cat.estado"
                  (change)="cambiarEstado(cat.id, !cat.estado)"
                >
                <span
                  class="relative h-6 w-12 rounded-full bg-slate-300 transition-colors peer-checked:bg-emerald-500 after:absolute after:left-0.5 after:top-0.5 after:h-5 after:w-5 after:rounded-full after:bg-white after:transition-transform peer-checked:after:translate-x-6"
                ></span>
              </label>

              <span class="whitespace-nowrap text-xs text-slate-500">
                Activar o desactivar proyecto
              </span>
            </div>
          </td>

          <!-- Acción: Crear Plantilla -->
          <td class="px-4 py-3 text-center text-sm text-slate-700">
            <button
              class="inline-flex items-center gap-1 rounded-lg bg-sky-500 px-3 py-1.5 text-xs font-semibold text-white transition hover:bg-sky-600 disabled:cursor-not-allowed disabled:bg-slate-300"
              (click)="redirigirPlantillas(cat.id)"
              [disabled]="!cat.estado"
            >
              <span class="material-symbols">add</span>
              Crear Plantilla
            </button>
          </td>
        </tr>

        @if (categoriasPaginadas.length === 0) {
          <tr>
            <td colspan="8" class="py-4 text-center text-sm text-slate-400">
              No hay categorías registradas.
            </td>
          </tr>
        }
      </tbody>
    </table>

    <!-- Paginación con componente compartido -->
    <shared-paginacion [datos]="categorias" [totalRegistros]="totalRegistros" [registrosPorPagina]="10"
      (cambioPagina)="onPaginaCambiada($event)">
    </shared-paginacion>
  </div>
</div>
<!-- ============================= -->
<!--      MODAL CREAR CATEGORÍA   -->
<!-- ============================= -->


<p-dialog header="Crear Categoría" [modal]="true" [visible]="visible()" (visibleChange)="visible.set($event)" [style]="{width: '40rem'}"
  (onHide)="cerrarModal()">

  <form [formGroup]="formCategoria" (ngSubmit)="guardarCategoria()">

    <div class="formgrid grid">

      <!-- NOMBRE DE LA CATEGORÍA -->
      <div class="field col-4">
        <label class="text-sm font-medium text-slate-700">Nombre de la categoría*</label>

        <input type="text" formControlName="nombreCategoria"
          (input)="validarCategoriaDuplicada(formCategoria.get('nombreCategoria')?.value)"
          class="w-full rounded-xl border border-slate-200 bg-white p-2 text-sm text-slate-700 outline-none focus:border-sky-500 focus:ring-2 focus:ring-sky-200"
          [ngClass]="{
            'border-red-500': errorMessage() || (formCategoria.get('nombreCategoria')?.invalid && formCategoria.get('nombreCategoria')?.touched),
            'focus:border-red-500': errorMessage()
          }">

        <!-- Mensaje de error de validación requerida -->
        @if (formCategoria.get('nombreCategoria')?.invalid && formCategoria.get('nombreCategoria')?.touched && !errorMessage()) {
          <p class="mt-2 text-xs text-red-600">El nombre es obligatorio.</p>
        }

        <!-- Mensaje de error de categoría duplicada -->
        @if (errorMessage()) {
          <p class="mt-2 text-xs text-red-600">{{ errorMessage() }}</p>
        }
      </div>

      <!-- PROYECTO -->
      <div class="field col-4">
        <label class="text-sm font-medium text-slate-700">Nombre del proyecto*</label>
        <select
          formControlName="idProyecto"
          class="w-full rounded-xl border border-slate-200 bg-white p-2 text-sm text-slate-700"
        >
          <option value="">Seleccione</option>
          <option *ngFor="let p of proyectosDisponibles" [value]="p.id">{{ p.nombre }}</option>
        </select>
      </div>

      <!-- ESTADO -->
      <div class="field col-4">
        <label class="text-sm font-medium text-slate-700">Estado*</label>
        <select
          formControlName="estado"
          class="w-full rounded-xl border border-slate-200 bg-white p-2 text-sm text-slate-700"
        >
          <option [ngValue]="true">Activo</option>
          <option [ngValue]="false">Inactivo</option>
        </select>
      </div>

    </div>

    <!-- BOTONES -->
    <div class="mt-5 flex justify-end gap-2">
      <button
        type="button"
        class="inline-flex items-center rounded-lg border border-purple-200 px-4 py-2 text-sm font-semibold text-purple-700 transition hover:bg-purple-50"
        (click)="cerrarModal()"
      >
        Cancelar
      </button>
      <button
        type="submit"
        class="inline-flex items-center gap-2 rounded-lg bg-sky-500 px-4 py-2 text-sm font-semibold text-white transition hover:bg-sky-600 disabled:cursor-not-allowed disabled:bg-slate-300"
        [disabled]="!formCategoria.valid || errorMessage() !== ''"
      >
        @if (loading()) {
          <div class="h-4 w-4 animate-spin rounded-full border-2 border-white/40 border-t-white"></div>
        }
        Guardar
      </button>
    </div>

  </form>

</p-dialog>
